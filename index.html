<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Agent Workflow</title>
    <!-- Removed incorrect keyword meta tags -->
    <meta name="description" content="AI Workflow Agent for planning complex, multi-step tasks. Define, break down, and execute workflows for business, personal projects, and more.">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/a7c6453d5a.js" crossorigin="anonymous"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7fafc; }
        .chat-bubble-user {
            background-color: #3b82f6; /* Blue 500 */
            color: white;
            border-bottom-right-radius: 0;
            max-width: 90%;
            word-wrap: break-word;
        }
        .chat-bubble-agent {
            background-color: #e5e7eb; /* Gray 200 */
            color: #1f2937; /* Gray 800 */
            border-bottom-left-radius: 0;
            max-width: 90%;
            word-wrap: break-word;
        }
        .loading-dot {
            animation: dot-flicker 1.4s infinite ease-in-out both;
        }
        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes dot-flicker {
            0%, 80%, 100% { opacity: 0; }
            40% { opacity: 1; }
        }
        /* Custom scrollbar for chat log */
        #chat-log::-webkit-scrollbar { width: 8px; }
        #chat-log::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        #chat-log::-webkit-scrollbar-track { background-color: #f1f1f1; }
    </style>
</head>
<body class="min-h-screen flex flex-col antialiased">

    <!-- Main Content Area -->
    <div id="app" class="flex flex-col flex-grow w-full max-w-4xl mx-auto p-4 md:p-6 lg:p-8">

        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800 flex items-center justify-center">
                <i class="fas fa-robot text-indigo-500 mr-2"></i>
                Workflow Agent
            </h1>
            <p class="text-gray-500 mt-1">Chat to define and execute complex, multi-step tasks.</p>
        </header>

        <!-- Chat Log Area -->
        <div id="chat-log" class="flex-grow bg-white p-4 sm:p-6 border border-gray-200 rounded-xl shadow-lg mb-4 overflow-y-auto" style="height: 60vh;">
            <!-- Initial Agent Message -->
            <div class="flex justify-start mb-4">
                <div class="flex-shrink-0 mr-3 mt-1">
                    <div class="w-8 h-8 rounded-full bg-indigo-500 text-white flex items-center justify-center">
                        <i class="fas fa-brain"></i>
                    </div>
                </div>
                <div class="p-3 rounded-xl chat-bubble-agent shadow-md">
                    Hello! I'm your AI Workflow Agent. Tell me about a multi-step task you need to accomplish (e.g., "Plan a surprise party for a friend," or "Draft a business strategy for a new product launch"). I will break it down into steps and help you execute them.
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="bg-white p-4 border border-gray-200 rounded-xl shadow-lg flex items-center">
            <textarea id="user-input"
                class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 resize-none overflow-hidden h-12"
                placeholder="Type your prompt here..."
                rows="1"
                oninput="autoResize(this)"
                onkeydown="handleKeyDown(event)"
                aria-label="User input for AI prompt"
            ></textarea>
            <button id="send-button" onclick="sendMessage()"
                class="ml-3 px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out disabled:opacity-50"
                disabled>
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>

    </div>

    <!-- Footer -->
    <footer class="text-center p-4 text-xs text-gray-400 border-t border-gray-100">
        AI Agent powered by Gemini.
    </footer>

    <script type="module">
        // Global Constants
        const GEMINI_API_URL_BASE = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=';
        const apiKey = ""; // API key will be provided at runtime
        const maxRetries = 5;
        const initialDelay = 1000; // 1 second

        let chatHistory = [];
        let isAgentThinking = false;

        // DOM Elements
        const chatLog = document.getElementById('chat-log');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');

        // --- Utility Functions ---

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
            sendButton.disabled = textarea.value.trim() === '' || isAgentThinking;
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                if (userInput.value.trim() !== '' && !isAgentThinking) {
                    sendMessage();
                }
            }
        }

        function scrollChatToBottom() {
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        function createMessageElement(text, role) {
            const isUser = role === 'user';
            const messageContainer = document.createElement('div');
            messageContainer.className = `flex mb-4 ${isUser ? 'justify-end' : 'justify-start'}`;

            const profileIcon = document.createElement('div');
            profileIcon.className = `flex-shrink-0 ${isUser ? 'ml-3' : 'mr-3'} mt-1`;
            profileIcon.innerHTML = isUser
                ? `<div class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center"><i class="fas fa-user"></i></div>`
                : `<div class="w-8 h-8 rounded-full bg-indigo-500 text-white flex items-center justify-center"><i class="fas fa-brain"></i></div>`;

            const bubble = document.createElement('div');
            bubble.className = `p-3 rounded-xl shadow-md ${isUser ? 'chat-bubble-user' : 'chat-bubble-agent'}`;
            bubble.innerHTML = marked.parse(text); // Use marked.js for Markdown

            if (isUser) {
                messageContainer.appendChild(bubble);
                messageContainer.appendChild(profileIcon);
            } else {
                messageContainer.appendChild(profileIcon);
                messageContainer.appendChild(bubble);
            }

            chatLog.appendChild(messageContainer);
            scrollChatToBottom();
        }

        function showLoadingIndicator() {
            const loadingContainer = document.createElement('div');
            loadingContainer.id = 'loading-indicator';
            loadingContainer.className = 'flex justify-start mb-4';
            loadingContainer.innerHTML = `
                <div class="flex-shrink-0 mr-3 mt-1">
                    <div class="w-8 h-8 rounded-full bg-indigo-500 text-white flex items-center justify-center">
                        <i class="fas fa-brain"></i>
                    </div>
                </div>
                <div class="p-3 rounded-xl chat-bubble-agent shadow-md flex items-center">
                    <span class="loading-dot w-2 h-2 bg-gray-600 rounded-full mr-1"></span>
                    <span class="loading-dot w-2 h-2 bg-gray-600 rounded-full mr-1"></span>
                    <span class="loading-dot w-2 h-2 bg-gray-600 rounded-full"></span>
                </div>
            `;
            chatLog.appendChild(loadingContainer);
            scrollChatToBottom();
        }

        function hideLoadingIndicator() {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // --- Core Chat and API Logic ---

        async function fetchWithRetry(url, payload, retries = maxRetries, delay = initialDelay) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        return response;
                    } else if (response.status === 429 && i < retries - 1) {
                        // Rate limit error (429) - retry with exponential backoff
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                        continue;
                    } else {
                        throw new Error(`API returned status ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    if (i === retries - 1) {
                        throw new Error(`Failed to fetch content after ${retries} attempts: ${error.message}`);
                    }
                    // Network error or other non-429 error, retry with backoff
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }

        const SYSTEM_INSTRUCTION = `You are a sophisticated AI Workflow Agent. Your primary role is to help the user break down complex requests into actionable, sequential steps and provide content or analysis for those steps.

RULES:
1. When the user gives a complex goal (e.g., "Plan a trip to Tokyo"), you MUST first respond with a numbered, multi-step plan (a "Workflow").
2. After presenting the initial Workflow, wait for the user to select or confirm a specific step before proceeding.
3. If the user asks for action on a specific step (e.g., "Start Step 1"), execute that step and provide the required output (text, analysis, or structured data).
4. ALWAYS maintain a friendly, conversational, and helpful tone.
5. Use Google Search grounding for any request that requires real-time information (e.g., current events, stock prices, weather, recent news).
6. Format your final output for readability using Markdown.

Example Workflow Response:
"That's a fantastic goal! To draft a marketing plan for your new product, here is a suggested workflow:
1. Define Target Audience and Key Messaging.
2. Outline Marketing Channels (Digital, Social, Print).
3. Create a Content Strategy for Q1.
4. Establish Key Performance Indicators (KPIs) and Budget.

Which step would you like to focus on first?"
`;

        async function getAgentResponse(prompt) {
            const apiUrl = `${GEMINI_API_URL_BASE}${apiKey}`;

            // Add the user's new message to the history
            chatHistory.push({ role: 'user', parts: [{ text: prompt }] });

            const payload = {
                contents: chatHistory,
                // Use Google Search grounding tool for general knowledge and up-to-date facts
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: SYSTEM_INSTRUCTION }]
                }
            };

            try {
                // Remove loading indicator before starting API call
                hideLoadingIndicator();
                isAgentThinking = true;
                sendButton.disabled = true;
                showLoadingIndicator();

                const response = await fetchWithRetry(apiUrl, payload);
                const result = await response.json();

                hideLoadingIndicator();
                isAgentThinking = false;
                sendButton.disabled = userInput.value.trim() === ''; // Re-enable if input has text

                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const agentText = candidate.content.parts[0].text;
                    
                    // Add the agent's response to history
                    chatHistory.push({ role: 'model', parts: [{ text: agentText }] });
                    createMessageElement(agentText, 'agent');

                } else {
                    const errorMsg = "Agent failed to generate a response. Please try again.";
                    console.error("Agent API error:", result);
                    createMessageElement(`*${errorMsg}*`, 'agent');
                    // Remove the failed user prompt from history to avoid confusion
                    chatHistory.pop();
                }

            } catch (error) {
                hideLoadingIndicator();
                isAgentThinking = false;
                sendButton.disabled = userInput.value.trim() === ''; // Re-enable if input has text
                const errorMsg = `An API error occurred: ${error.message}`;
                console.error(errorMsg);
                createMessageElement(`*${errorMsg}*`, 'agent');
                // Remove the user prompt from history upon failure
                chatHistory.pop();
            }
        }

        window.sendMessage = async function() {
            const input = userInput.value.trim();
            if (input === '' || isAgentThinking) return;

            // Display user message
            createMessageElement(input, 'user');

            // Clear input and auto-resize
            userInput.value = '';
            autoResize(userInput);
            
            // Get Agent response
            await getAgentResponse(input);
        }

        // Initialization: Load Marked.js for Markdown rendering in chat bubbles
        function loadMarkedScript() {
            return new Promise((resolve) => {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
                script.onload = resolve;
                document.head.appendChild(script);
            });
        }

        // On Load Logic
        window.onload = async () => {
            // Load Markdown renderer
            await loadMarkedScript();
            
            // Enable button if text exists
            sendButton.disabled = userInput.value.trim() === '' || isAgentThinking;
            
            // Initial auto-resize
            autoResize(userInput);
        };
    </script>
</body>
</html>
