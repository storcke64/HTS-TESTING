<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTS Temporal Continuity Test Tool</title>
    
    <!-- --- PWA Meta Tags (Required for App Installation) --- -->
    <meta name="description" content="A continuous time standard converter for the Human Time System." />
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <link rel="apple-touch-icon" href="icon-192.png"> 
    
    <!-- Load Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for better aesthetics and readability */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937; /* Dark background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }
        .container-card {
            background-color: #111827; /* Darker card */
            color: #f3f4f6;
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.5);
            border: 1px solid #374151;
        }
        .input-style, .output-style {
            background-color: #1f2937;
            color: #d1d5db;
        }
    </style>
</head>
<body class="selection:bg-indigo-700">

    <div id="app" class="container-card max-w-lg w-full p-8 md:p-10 rounded-xl">
        <h1 class="text-4xl font-extrabold text-indigo-400 mb-2">HTS Continuous Time Demo</h1>
        
        <!-- --- START: Update Status Line (Requested) --- -->
        <p class="text-xs text-yellow-400 font-semibold mb-2 p-1 border border-yellow-700 bg-yellow-900/30 rounded-md inline-block">
            Update Status: PWA and Scope Fixes Applied
        </p>
        <!-- --- END: Update Status Line --- -->

        <p class="text-sm text-gray-400 mb-6">
            Converts conventional date/time to the continuous Human Time System (HTS) value, and vice-versa.
        </p>

        <!-- Live Clock Section -->
        <div class="mb-8 p-4 bg-indigo-900/30 rounded-lg border border-indigo-700/50">
            <p class="text-xs font-semibold uppercase text-indigo-300 mb-1">Current HTS Value</p>
            <p id="liveHtsOutput" class="text-3xl font-mono text-indigo-300 break-words">0.00000000</p>
        </div>

        <!-- Conversion Block (Gregorian to HTS) -->
        <div class="space-y-4 mb-10 pb-6 border-b border-gray-700">
            <h2 class="text-xl font-semibold text-gray-300">1. Gregorian to HTS</h2>
            <label for="dateTimeInput" class="block text-sm font-medium text-gray-400">
                Enter Date & Time (e.g., 2025-12-01T10:30)
            </label>
            <input type="datetime-local" id="dateTimeInput" class="input-style w-full p-3 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" value="2025-12-01T10:30">

            <button id="convertButton" class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg hover:bg-indigo-500 transition duration-200 shadow-md shadow-indigo-800/50">
                Convert to HTS Value
            </button>
            
            <div id="htsResultContainer" class="output-style p-4 rounded-lg border border-indigo-700 break-words flex justify-between items-center mt-3">
                <p id="htsOutput" class="text-xl font-mono text-indigo-300">0.00000000</p>
                <button id="copyButton" class="text-indigo-500 hover:text-indigo-300 transition duration-150 p-2 rounded-full hidden">
                    <!-- Copy Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2v-1M8 5h8m-8 0v2m8-2v2m-8 4h8m-8 4h8" />
                    </svg>
                </button>
            </div>
            <p id="errorBox" class="text-red-400 mt-2 hidden text-sm"></p>
        </div>
        
        <!-- Reverse Conversion Block (HTS to Gregorian) -->
        <div class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-300">2. HTS to Gregorian</h2>
            <label for="htsInput" class="block text-sm font-medium text-gray-400">
                Enter HTS Value (e.g., 20387.4375)
            </label>
            <input type="number" step="any" id="htsInput" class="input-style w-full p-3 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="Enter HTS Value">

            <button id="reverseConvertButton" class="w-full bg-green-600 text-white font-semibold py-3 rounded-lg hover:bg-green-500 transition duration-200 shadow-md shadow-green-800/50">
                Convert to Gregorian Date
            </button>
            
            <div id="gregorianResultContainer" class="output-style p-4 rounded-lg border border-green-700 break-words flex justify-between items-center mt-3">
                <p id="gregorianOutput" class="text-xl font-mono text-green-300">---</p>
            </div>
            <p id="reverseErrorBox" class="text-red-400 mt-2 hidden text-sm"></p>
        </div>


        <!-- Epoch Reference -->
        <div class="mt-8 text-xs text-gray-500 pt-4 border-t border-gray-800">
            <p>* HTS is defined as the continuous floating-point number of standard terrestrial days elapsed since the Unix Epoch: **Jan 1, 1970, 00:00:00 UTC**.</p>
        </div>
    </div>

    <script>
        // --- Core HTS Constants ---
        // Set the HTS reference epoch to Jan 1, 1970, 00:00:00 UTC (Unix Epoch)
        const HTS_EPOCH_MS = 0; 
        // 1 HTS Unit is equivalent to the milliseconds in one standard terrestrial day.
        const MS_PER_DAY = 86400000; 

        // --- Functions: Gregorian to HTS ---

        /**
         * Converts a standard Date object into a continuous Human Time System (HTS) value.
         */
        function convertToHTS(date) {
            const timeDifferenceMs = date.getTime() - HTS_EPOCH_MS;
            // Calculate the continuous number of days (or HTS units)
            const htsValue = timeDifferenceMs / MS_PER_DAY;
            
            // Format to 8 decimal places for high precision demonstration
            return htsValue.toFixed(8); 
        }

        function handleConversion() {
            const inputElement = document.getElementById('dateTimeInput');
            const outputElement = document.getElementById('htsOutput');
            const errorBox = document.getElementById('errorBox');
            const copyButton = document.getElementById('copyButton');
            
            // Clear previous errors
            errorBox.classList.add('hidden');
            errorBox.textContent = '';
            outputElement.textContent = '0.00000000';
            copyButton.classList.add('hidden'); 

            const dateTimeString = inputElement.value;
            
            if (!dateTimeString) {
                errorBox.textContent = 'Please enter a valid date and time.';
                errorBox.classList.remove('hidden');
                return;
            }

            try {
                // Treats the input as local time and gets the UTC milliseconds
                const date = new Date(dateTimeString);
                
                if (isNaN(date.getTime())) {
                    throw new Error("Invalid date input.");
                }

                const htsResult = convertToHTS(date);
                outputElement.textContent = htsResult;
                copyButton.classList.remove('hidden'); 
                
            } catch (error) {
                console.error("Conversion error:", error);
                errorBox.textContent = `Error: Could not parse date. Please check the format.`;
                errorBox.classList.remove('hidden');
            }
        }
        
        /**
         * Copies the HTS output text to the clipboard.
         */
        function copyToClipboard() {
            const outputElement = document.getElementById('htsOutput');
            const textToCopy = outputElement.textContent;
            const copyButton = document.getElementById('copyButton');
            
            const textarea = document.createElement('textarea');
            textarea.value = textToCopy;
            textarea.style.position = 'fixed'; 
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    copyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>`;
                    setTimeout(() => {
                        copyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2v-1M8 5h8m-8 0v2m8-2v2m-8 4h8m-8 4h8" /></svg>`;
                    }, 2000);
                }
            } catch (err) {
                console.error('Could not copy text: ', err);
                const errorBox = document.getElementById('errorBox');
                errorBox.textContent = 'Copy failed. Please copy manually.';
                errorBox.classList.remove('hidden');
            }
            document.body.removeChild(textarea);
        }

        // --- Functions: HTS to Gregorian ---

        /**
         * Converts a continuous HTS value back to a standard Gregorian date string (UTC).
         * @param {number} htsValue - The HTS continuous value.
         * @returns {string} The formatted UTC Gregorian date string.
         */
        function convertFromHTS(htsValue) {
            const timeDifferenceMs = htsValue * MS_PER_DAY;
            const targetMs = HTS_EPOCH_MS + timeDifferenceMs;
            
            // Create a Date object from the calculated milliseconds
            const date = new Date(targetMs);
            
            // Return a clean, human-readable UTC string
            return date.toUTCString();
        }

        function handleReverseConversion() {
            const inputElement = document.getElementById('htsInput');
            const outputElement = document.getElementById('gregorianOutput');
            const errorBox = document.getElementById('reverseErrorBox');

            // Clear previous errors
            errorBox.classList.add('hidden');
            errorBox.textContent = '';
            outputElement.textContent = '---';

            const htsString = inputElement.value;
            const htsValue = parseFloat(htsString);

            if (isNaN(htsValue) || htsString.trim() === '') {
                errorBox.textContent = 'Please enter a valid numeric HTS Value.';
                errorBox.classList.remove('hidden');
                return;
            }

            try {
                const gregorianResult = convertFromHTS(htsValue);
                outputElement.textContent = gregorianResult;
            } catch (error) {
                console.error("Reverse conversion error:", error);
                errorBox.textContent = `Error during conversion.`;
                errorBox.classList.remove('hidden');
            }
        }
        
        // --- Live Clock Function ---

        function updateLiveClock() {
            const now = new Date();
            const htsValue = convertToHTS(now);
            document.getElementById('liveHtsOutput').textContent = htsValue;
        }
        
        // --- PWA Service Worker Registration ---
        // FIX: Dynamically calculate the path and explicitly set the scope for GitHub Pages.
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const path = window.location.pathname;
                
                // 1. Calculate the path to the Service Worker file
                const serviceWorkerPath = path.endsWith('/index.html') 
                    ? path.replace('index.html', 'sw.js') 
                    : '/sw.js';
                
                // 2. Calculate the required scope (the directory of the app)
                const appScope = path.endsWith('/') 
                    ? path 
                    : path.substring(0, path.lastIndexOf('/') + 1);

                // 3. Register with both the path and the explicit scope
                navigator.serviceWorker.register(serviceWorkerPath, { scope: appScope })
                    .then(registration => {
                        console.log('Service Worker registered successfully with scope: ', registration.scope);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed: ', error);
                    });
            });
        }


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Setup Event Listeners
            document.getElementById('convertButton').addEventListener('click', handleConversion);
            document.getElementById('copyButton').addEventListener('click', copyToClipboard);
            document.getElementById('reverseConvertButton').addEventListener('click', handleReverseConversion);

            // Run initial conversion for default value
            handleConversion(); 
            
            // Start the live clock update
            updateLiveClock(); // Run immediately
            setInterval(updateLiveClock, 100); // Update every 100 milliseconds
        });

    </script>
</body>
</html>
